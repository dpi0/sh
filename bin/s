#!/usr/bin/env bash

search_term="$1"

SELECTED_FILE=$(
  fd . $HOME --type f --hidden --follow --color=always \
    --exclude ".rustup" \
    --exclude "node_modules" \
    --exclude ".cargo" \
    --exclude ".continue" \
    --exclude ".cargo" \
    --exclude "go/pkg/mod" \
    --exclude ".npm" \
    --exclude ".cache" |
    fzf \
      --query="$search_term" \
      --exact \
      --extended \
      --preview="bat --style=numbers --color=always --line-range :500 {}" \
      --preview-window="right:50%" \
      --ansi
)

if [ -n "$SELECTED_FILE" ]; then
  file_extension="${SELECTED_FILE##*.}"

  case "$file_extension" in
    pdf) evince "$SELECTED_FILE" ;;
    jpg | jpeg | png | gif | bmp | webp) (command -v loupe &> /dev/null && loupe "$SELECTED_FILE") || (command -v org.kde.gwenview &> /dev/null && org.kde.gwenview "$SELECTED_FILE") ;;
    mp4 | mkv | avi | webm) mpv "$SELECTED_FILE" ;;
    txt | py | rs | go | md) (command -v nvim &> /dev/null && nvim "$SELECTED_FILE") || vim "$SELECTED_FILE" ;;
    *) (command -v nvim &> /dev/null && nvim "$SELECTED_FILE") || vim "$SELECTED_FILE" ;;
  esac

  # Copy file path to clipboard if wl-copy is available
  command -v wl-copy &> /dev/null && echo "$SELECTED_FILE" | wl-copy

  # Print the file path
  echo "$SELECTED_FILE"
fi
