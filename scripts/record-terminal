#!/usr/bin/env bash
set -e # Exit if any command fails

# Configuration
OUTPUT_DIR="$HOME/Screenshots/recordings"
THEME="monokai"
FONT_FAMILY="JetBrainsMono Nerd Font"
FONT_SIZE=28
TERMINAL_WIDTH=100
TERMINAL_HEIGHT=30

# Create the directory if it doesn't exist
mkdir -p "$OUTPUT_DIR"

# Generate the timestamp and filename
timestamp=$(date +'%d-%m-%Y_%H-%M-%S')
filename="Terminal_Recording_$timestamp.cast"
filepath="$OUTPUT_DIR/$filename"
gif_filepath="${filepath%.cast}.gif"

echo "ğŸ¥ Recording terminal session..."
echo "ğŸ“‚ Output will be saved to: $filepath"
echo "âš™ï¸  Press Ctrl+D to stop recording"
echo ""

# Check if required commands exist
for cmd in asciinema agg; do
  if ! command -v $cmd &> /dev/null; then
    echo "âŒ Error: Required command '$cmd' not found."
    echo "Please install the missing dependency and try again."
    exit 1
  fi
done

# Record the terminal session
asciinema rec --tty-size=${TERMINAL_WIDTH}x${TERMINAL_HEIGHT} --title="terminal-$timestamp" "$filepath"

# After recording, convert to GIF
echo "ğŸ”„ Converting recording to GIF..."
if agg --theme "$THEME" --font-size "$FONT_SIZE" --font-family "$FONT_FAMILY" "$filepath" "$gif_filepath"; then
  echo "âœ… GIF created: $gif_filepath"
else
  echo "âŒ Failed to create GIF"
  exit 1
fi

# Prompt to upload the GIF with default to yes
read -p "ğŸ“¤ Upload ${gif_filepath} to bin.dpi0.cloud? [Y/n]: " upload_choice
if [[ "$upload_choice" =~ ^[Nn]$ ]]; then
  echo "â­ï¸  Skipping upload"
else
  if command -v pst &> /dev/null; then
    echo "ğŸ”„ Uploading GIF..."
    pst "$gif_filepath"
  else
    echo "âš ï¸  pst command not found. Skipping upload."
  fi
fi

# Prompt to remove the original recording file with default to yes
read -p "ğŸ—‘ï¸  Remove original recording file ($filename)? [Y/n]: " remove_choice
if [[ "$remove_choice" =~ ^[Nn]$ ]]; then
  echo "ğŸ’¾ Keeping original recording: $filepath"
else
  rm "$filepath"
  echo "ğŸ—‘ï¸  Removed original recording: $filepath"
fi

echo "âœ¨ All done!"
